# v2 系统部署指南

## 1. 门卫电脑（Windows）部署

### 1.1 环境准备
- 安装 Python 3.10（建议使用 conda 环境）
- 安装依赖：
  cd windows_pc
  pip install -r requirements.txt

### 1.2 配置修改
编辑 config.py：
- DB_PATH：数据库路径（默认即可）
- COOLDOWN_SECONDS：放行后冷却时间（秒）
- FLASK_HOST：如需局域网访问，保持 0.0.0.0
- FLASK_PORT：端口号（默认5000）

### 1.3 启动服务
python app.py
或双击 run.bat（需修改 conda 环境名）。

### 1.4 防火墙设置
开放 5000 端口，允许树莓派访问。

---

## 2. 树莓派端部署

### 2.1 系统准备
- 烧录 Raspberry Pi OS Lite（或 Ubuntu Server）
- 开启 SSH，连接 Wi-Fi（参考“无头模式”教程）

### 2.2 环境配置
sudo apt update
sudo apt install python3-pip
pip install -r raspberry_pi/requirements.txt
若使用 CSI 摄像头，需安装 picamera2：
sudo apt install python3-picamera2

### 2.3 配置修改
编辑 raspberry_pi/config.py：
- PC_IP：门卫电脑的 IP 地址
- CAMERA_TYPE：'usb' 或 'csi'
- 根据需要调整摄像头索引、分辨率、跳帧等参数。

### 2.4 运行测试
python detect.py

### 2.5 开机自启（可选）
编辑 /etc/rc.local 或创建 systemd 服务。

---

## 3. STM32 端部署

### 3.1 硬件连接
- 串口1 (USART1): PA9(TX), PA10(RX) 连接至 USB转TTL 模块（调试用）或树莓派串口
- 舵机信号线: PA8 (TIM1_CH1) 连接舵机控制线
- 红外传感器: PA0 连接红外输出（低电平表示有车）

### 3.2 工程生成与烧录
1. 使用 STM32CubeMX 打开 stm32f103c8t6.ioc，重新生成代码（如需修改引脚）
2. 用 Keil5 打开 MDK-ARM/stm32.uvprojx，编译并下载。

### 3.3 串口通信
- 波特率：115200
- 指令格式：以 \n 结尾的字符串
  - OPEN_GATE：开闸
  - CLOSE_GATE：关闸
  - GET_STATUS：查询状态

---

## 4. 系统联调

### 4.1 测试流程
1. 启动门卫电脑 Flask 服务。
2. 启动树莓派 detect.py，观察日志是否能检测到车牌并上传。
3. 用浏览器访问 http://<电脑IP>:5000，查看实时监控页面。
4. 手动添加白名单车牌，测试通行判断。
5. 连接 STM32，发送 OPEN_GATE 指令，观察舵机动作。

### 4.2 常见问题
- 树莓派无法连接电脑：检查 IP、防火墙、Flask 是否运行。
- 识别不准：调整 easyocr_plate.py 中的预处理参数或置信度阈值。
- 串口通信乱码：检查波特率是否一致、电平是否匹配（TTL电平）。